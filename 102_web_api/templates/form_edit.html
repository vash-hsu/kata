<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Manipulation</title>
  <script src="/static/script/jquery-3.1.1.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/static/css/bootstrap.css">
</head>

<body>

<div class="container">

<!-- template generated by http://bootsnipp.com/forms?version=3 -->

<form class="form-horizontal">
<fieldset>

<!-- Form Name -->
<legend>manipulator</legend>

<!-- Multiple Radios (inline) -->
<div class="form-group">
  <label class="col-md-4 control-label" for="radios">options</label>
  <div class="col-md-4">
    {% if put %}
    <label class="radio-inline" for="radios-1">
      <input name="radios" id="radios-put" value="'update'" type="radio" checked="checked">
      put/update
    </label>
    {% endif %}
    <label class="radio-inline" for="radios-2">
      {% if put %}
      <input name="radios" id="radios-delete" value="'delete'" type="radio">
      {% else %}
      <input name="radios" id="radios-delete" value="'delete'" type="radio" checked="checked">
      {% endif %}
      delete
    </label>
  </div>
</div>

<!-- Textarea -->
<div class="form-group">
  <label class="col-md-4 control-label" for="json_input">JSON</label>
  <div class="col-md-4">
    <textarea class="form-control" id="json_input" name="json_input" rows="6">
      {'name': 'value'}</textarea>
  </div>
</div>

<!-- Button (Double) -->
<div class="form-group" onsubmit="return false">
  <label class="col-md-4 control-label" for="button2confirm">action</label>
  <div class="col-md-8">
    <button id="button2confirm" name="button2confirm" class="btn btn-success">Confirm</button>
    <button id="button2cancel" name="button2cancel" class="btn btn-danger">Reload</button>
  </div>
</div>

</fieldset>
</form>
</div>

<script>

var resource_url = "{{ resource_url }}";

{% if put %}
var action_type = "put";
var resource_id = "{{ put }}";
{% else %}
var action_type = "delete";
var resource_id = "{{ delete }}";
{% endif %}

var referer_url = "{{ referer_url }}";
document.title = "console for " + action_type.toUpperCase();

function update_text_field(json_object)
{
  // console.log(raw_data);
  // alert("server return status = ".concat(json_object.status))
  document.getElementById("json_input").value = JSON.stringify(
    json_object.value, null, 2);
  document.getElementById("button2confirm").disabled = false;
}

function retrieve_json(_base_url, _id)
{
  var target_url = _base_url.concat("/", _id);
  jQuery.ajax({
    url: target_url,
    type: "GET",
    contentType: 'application/json; charset=utf-8',
    success: function(resultData){
      update_text_field(resultData);
    },
    error: function(jqXHR, textStatus, errorThrown){
    },
    timeout: 10000,
  });
}

function put_json(_url, _id, user_input)
{
  var target_url = _url.concat("/", _id);
    jQuery.ajax({
      url: target_url,
      type: "PUT",
      data: user_input,
      contentType: 'application/json; charset=utf-8',
      success: function(resultData){
        // alert('server return status = '.concat(resultData.status));
        if (parseInt(resultData.status) < 0)
        {
          alert('server return reason = '.concat(resultData.reason.toString()))
        }
        else
        {
          alert('Successfully to update resource '.concat(_id));
        }
      },
      error: function(jqXHR, textStatus, errorThrown){
      },
      timeout: 10000,
    });
}

// delete_json(resource_url, resource_id);
function delete_json(_url, _id)
{
  var target_url = _url.concat("/", _id);
  jQuery.ajax({
    url: target_url,
    type: "DELETE",
    data: "{}",
    contentType: 'application/json; charset=utf-8',
    success: function(resultData){
      if (parseInt(resultData.status) < 0)
      {
        alert('server return reason = '.concat(resultData.reason.toString()))
      }
      else
      {
        alert('Successfully to delete resource '.concat(_id));
        if (referer_url.length == 0) // close current tab
        {
          window.top.close();
        }
        else
        {
          window.location.href = referer_url;
        }
      }
    },
    error: function(jqXHR, textStatus, errorThrown)
    {
    },
    timeout: 10000,
  });
}

function click_submit()
{
  //if (document.getElementById("radios-put").checked)
  if ((document.getElementById("radios-put")) && (document.getElementById("radios-put").checked))
  {
    user_inpu = document.getElementById("json_input").value;
    put_json(resource_url, resource_id, user_inpu);
  }
  else if (document.getElementById("radios-delete").checked)
  {
    delete_json(resource_url, resource_id);
  }
}

document.getElementById("button2confirm").disabled = true;
// http://stackoverflow.com/questions/14938290/how-to-avoid-refreshing-the-page-in-a-bootstrap-modal
$("#button2confirm").on("click", function(e) {
    e.preventDefault();
    click_submit();
});
$("#button2cancel").on("click", function(e) {
    e.preventDefault();
    location.reload();
});

retrieve_json(resource_url, resource_id);

</script>


</body>
</html>
